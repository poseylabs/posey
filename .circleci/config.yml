version: 2.1

orbs:
  docker: circleci/docker@2.5.0
  path-filtering: circleci/path-filtering@1.0.0
  # Local orbs
  common: local/common-orb
  data-postgres: local/data-postgres-orb
  data-couchbase: local/data-couchbase-orb
  data-vector-db: local/data-vector-db-orb
  service-auth: local/service-auth-orb
  service-cron: local/service-cron-orb
  service-mcp: local/service-mcp-orb
  service-supertokens: local/service-supertokens-orb
  service-voyager: local/service-voyager-orb
  service-agents: local/service-agents-orb

# Define orb directories
orbs-dirs:
  local:
    common-orb: .circleci/orbs/common-orb.yml
    data-postgres-orb: .circleci/orbs/data-postgres-orb.yml
    data-couchbase-orb: .circleci/orbs/data-couchbase-orb.yml
    data-vector-db-orb: .circleci/orbs/data-vector-db-orb.yml
    service-auth-orb: .circleci/orbs/service-auth-orb.yml
    service-cron-orb: .circleci/orbs/service-cron-orb.yml
    service-mcp-orb: .circleci/orbs/service-mcp-orb.yml
    service-supertokens-orb: .circleci/orbs/service-supertokens-orb.yml
    service-voyager-orb: .circleci/orbs/service-voyager-orb.yml
    service-agents-orb: .circleci/orbs/service-agents-orb.yml

parameters:
  run-workflow:
    default: true
    type: boolean
  run-auth-workflow:
    type: boolean
    default: false
  run-cron-workflow:
    type: boolean
    default: false
  run-voyager-workflow:
    type: boolean
    default: false
  run-mcp-workflow:
    type: boolean
    default: false
  run-supertokens-workflow:
    type: boolean
    default: false
  run-agents-workflow:
    type: boolean
    default: false
  run-vector-db-workflow:
    type: boolean
    default: false
  run-postgres-workflow:
    type: boolean
    default: false
  run-couchbase-workflow:
    type: boolean
    default: false
  run-auth-service-workflow:
    description: "Run Auth Service workflow"
    type: boolean
    default: false
  run-cron-service-workflow:
    description: "Run Cron Service workflow"
    type: boolean
    default: false

workflows:
  version: 2

  # Path-based filtering to determine what to build
  path-filtering:
    when: << pipeline.parameters.run-workflow >>
    jobs:
      - path-filtering/filter:
          name: check-updated-files
          mapping: |
            services/auth/.* run-auth-service-workflow true
            apps/cron/.* run-cron-service-workflow true
            data/postgres/.* run-postgres-workflow true
            data/couchbase/.* run-couchbase-workflow true
            data/vector-db/.* run-vector-db-workflow true
            services/mcp/.* run-mcp-workflow true
            services/supertokens/.* run-supertokens-workflow true
            services/voyager/.* run-voyager-workflow true
            services/agents/.* run-agents-workflow true
            .circleci/.* run-auth-service-workflow true
            .circleci/.* run-cron-service-workflow true
            .circleci/.* run-postgres-workflow true
            .circleci/.* run-couchbase-workflow true
            .circleci/.* run-vector-db-workflow true
            .circleci/.* run-mcp-workflow true
            .circleci/.* run-supertokens-workflow true
            .circleci/.* run-voyager-workflow true
            .circleci/.* run-agents-workflow true
          base-revision: main
          filters:
            branches:
              only:
                - main
                - develop
            tags:
              only: /^v.*/

  # Auth Service workflow
  auth-service:
    when: << pipeline.parameters.run-auth-service-workflow >>
    jobs:
      - service-auth/build-auth-service:
          context:
            - org-global
          filters:
            branches:
              only:
                - main
                - develop
            tags:
              only: /^v.*/

  # Cron Service workflow
  cron-service:
    when: << pipeline.parameters.run-cron-service-workflow >>
    jobs:
      - service-cron/build-cron-service:
          context:
            - org-global
          filters:
            branches:
              only:
                - main
                - develop
            tags:
              only: /^v.*/

  # MCP Service workflow
  mcp-service:
    when: << pipeline.parameters.run-mcp-workflow >>
    jobs:
      - service-mcp/build-mcp-service:
          context:
            - org-global
          filters:
            branches:
              only:
                - main
                - develop
            tags:
              only: /^v.*/

  # SuperTokens Service workflow
  supertokens-service:
    when: << pipeline.parameters.run-supertokens-workflow >>
    jobs:
      - service-supertokens/build-supertokens-service:
          context:
            - org-global
          filters:
            branches:
              only:
                - main
                - develop
            tags:
              only: /^v.*/

  # Voyager Service workflow
  voyager-service:
    when: << pipeline.parameters.run-voyager-workflow >>
    jobs:
      - service-voyager/build-voyager-service:
          context:
            - org-global
          filters:
            branches:
              only:
                - main
                - develop
            tags:
              only: /^v.*/

  # Agents Service workflow
  agents-service:
    when: << pipeline.parameters.run-agents-workflow >>
    jobs:
      - service-agents/build-agents-service:
          context:
            - org-global
          filters:
            branches:
              only:
                - main
                - develop
            tags:
              only: /^v.*/

  # Postgres workflow
  postgres:
    when: << pipeline.parameters.run-postgres-workflow >>
    jobs:
      - data-postgres/build-postgres:
          context:
            - org-global
          filters:
            branches:
              only:
                - main
                - develop
            tags:
              only: /^v.*/

  # Couchbase workflow
  couchbase:
    when: << pipeline.parameters.run-couchbase-workflow >>
    jobs:
      - data-couchbase/build-couchbase:
          context:
            - org-global
          filters:
            branches:
              only:
                - main
                - develop
            tags:
              only: /^v.*/

  # Vector DB workflow
  vector-db:
    when: << pipeline.parameters.run-vector-db-workflow >>
    jobs:
      - data-vector-db/build-vector-db:
          context:
            - org-global
          filters:
            branches:
              only:
                - main
                - develop
            tags:
              only: /^v.*/ 