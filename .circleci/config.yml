version: 2.1

# Define this as a setup configuration
setup: true

orbs:
  path-filtering: circleci/path-filtering@1.0.0

# Set up organization-level orbs
orbs-dir: .circleci/orbs
orbs-settings:
  namespace: posey

# Define pipeline parameters that will be passed to the continuation configuration
parameters:
  run-workflow:
    default: true
    type: boolean
  run-orb-publishing-workflow:
    description: "Run the workflow to publish orbs"
    type: boolean
    default: false
  orb-version-type:
    description: "Version type for orb publishing (patch, minor, major)"
    type: enum
    enum: ["patch", "minor", "major"]
    default: "patch"
  run-voyager-workflow:
    type: boolean
    default: false
  run-mcp-workflow:
    type: boolean
    default: false
  run-supertokens-workflow:
    type: boolean
    default: false
  run-agents-workflow:
    type: boolean
    default: false
  run-vector-db-workflow:
    type: boolean
    default: false
  run-postgres-workflow:
    type: boolean
    default: false
  run-couchbase-workflow:
    type: boolean
    default: false
  run-auth-service-workflow:
    description: "Run Auth Service workflow"
    type: boolean
    default: false
  run-cron-service-workflow:
    description: "Run Cron Service workflow"
    type: boolean
    default: false

workflows:
  # Path-based filtering to determine what to build
  path-filtering:
    jobs:
      - path-filtering/filter:
          pre-steps:
            - run:
                name: Install yq
                command: |
                  curl -L https://github.com/mikefarah/yq/releases/download/v4.40.5/yq_linux_amd64 -o /tmp/yq
                  chmod +x /tmp/yq
                  sudo mv /tmp/yq /usr/local/bin/yq
                  yq --version
            - run:
                name: Detect version bump type from commit message
                command: |
                  # Default is patch
                  VERSION_TYPE="patch"
                  
                  # Get the commit message
                  COMMIT_MSG=$(git log -1 --pretty=%B)
                  
                  # Check for version bump flags in commit message
                  if echo "$COMMIT_MSG" | grep -q "\[major\]"; then
                    VERSION_TYPE="major"
                  elif echo "$COMMIT_MSG" | grep -q "\[minor\]"; then
                    VERSION_TYPE="minor"
                  elif echo "$COMMIT_MSG" | grep -q "\[patch\]"; then
                    VERSION_TYPE="patch"
                  fi
                  
                  echo "Using version type: $VERSION_TYPE"
                  echo "export ORB_VERSION_TYPE=$VERSION_TYPE" >> $BASH_ENV
          name: check-updated-files
          mapping: |
            services/auth/.* run-auth-service-workflow true
            apps/cron/.* run-cron-service-workflow true
            data/postgres/.* run-postgres-workflow true
            data/couchbase/.* run-couchbase-workflow true
            data/vector-db/.* run-vector-db-workflow true
            services/mcp/.* run-mcp-workflow true
            services/supertokens/.* run-supertokens-workflow true
            services/voyager/.* run-voyager-workflow true
            services/agents/.* run-agents-workflow true
            .circleci/orbs/.* run-orb-publishing-workflow true
          parameters: |
            {
              "orb-version-type": "${ORB_VERSION_TYPE}"
            }
          base-revision: main
          # This is the path to the configuration file that will be used for the continuation
          config-path: .circleci/continue_config.yml
          filters:
            branches:
              only:
                - main
                - develop
            tags:
              only: /^v.*/ 