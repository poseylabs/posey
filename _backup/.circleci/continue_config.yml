version: 2.1

# Standard and local orbs
orbs:
  # Standard orbs from the registry
  docker: circleci/docker@2.5.0
  path-filtering: circleci/path-filtering@1.0.0
  cli: circleci/circleci-cli@0.1.9
  
  # Published orbs - using volatile for development
  common: posey/common@0.1.3
  service-auth: posey/service-auth@0.1.3
  service-cron: posey/service-cron@0.1.3
  data-postgres: posey/data-postgres@0.1.3
  data-couchbase: posey/data-couchbase@0.1.3
  data-vector-db: posey/data-vector-db@0.1.3
  service-mcp: posey/service-mcp@0.1.3
  service-supertokens: posey/service-supertokens@0.1.3
  service-voyager: posey/service-voyager@0.1.3
  service-agents: posey/service-agents@0.1.3

# Define the parameters that will be passed from the setup configuration
parameters:
  run-voyager-workflow:
    type: boolean
    default: false
  run-mcp-workflow:
    type: boolean
    default: false
  run-supertokens-workflow:
    type: boolean
    default: false
  run-agents-workflow:
    type: boolean
    default: false
  run-vector-db-workflow:
    type: boolean
    default: false
  run-postgres-workflow:
    type: boolean
    default: false
  run-couchbase-workflow:
    type: boolean
    default: false
  run-auth-service-workflow:
    description: "Run Auth Service workflow"
    type: boolean
    default: false
  run-cron-service-workflow:
    description: "Run Cron Service workflow"
    type: boolean
    default: false
  run-common-change-workflow:
    description: "Run the combined workflow when the common orb changes"
    type: boolean
    default: false

workflows:
  version: 2

  # Auth Service workflow
  auth-service:
    when: << pipeline.parameters.run-auth-service-workflow >>
    jobs:
      - service-auth/build-auth-service:
          context:
            - posey-prod-core
            - posey-prod-services
          filters:
            branches:
              only:
                - main
                - develop
            tags:
              only: /^v.*/

  # Cron Service workflow
  cron-service:
    when: << pipeline.parameters.run-cron-service-workflow >>
    jobs:
      - service-cron/build-cron-service:
          context:
            - posey-prod-core
            - posey-prod-services
          filters:
            branches:
              only:
                - main
                - develop
            tags:
              only: /^v.*/

  # MCP Service workflow
  mcp-service:
    when: << pipeline.parameters.run-mcp-workflow >>
    jobs:
      - service-mcp/build-mcp-service:
          context:
            - posey-prod-core
            - posey-prod-services
          filters:
            branches:
              only:
                - main
                - develop
            tags:
              only: /^v.*/

  # SuperTokens Service workflow
  supertokens-service:
    when: << pipeline.parameters.run-supertokens-workflow >>
    jobs:
      - service-supertokens/build-supertokens-service:
          context:
            - posey-prod-core
            - posey-prod-services
          filters:
            branches:
              only:
                - main
                - develop
            tags:
              only: /^v.*/

  # Voyager Service workflow
  voyager-service:
    when: << pipeline.parameters.run-voyager-workflow >>
    jobs:
      - service-voyager/build-voyager-service:
          context:
            - posey-prod-core
            - posey-prod-services
          filters:
            branches:
              only:
                - main
                - develop
            tags:
              only: /^v.*/

  # Agents Service workflow
  agents-service:
    when: << pipeline.parameters.run-agents-workflow >>
    jobs:
      - service-agents/build-agents-service:
          context:
            - posey-prod-core
            - posey-prod-services
          filters:
            branches:
              only:
                - main
                - develop
            tags:
              only: /^v.*/

  # Postgres workflow
  postgres:
    when: << pipeline.parameters.run-postgres-workflow >>
    jobs:
      - data-postgres/build-postgres:
          context:
            - posey-prod-core
            - posey-prod-data
          filters:
            branches:
              only:
                - main
                - develop
            tags:
              only: /^v.*/

  # Couchbase workflow
  couchbase:
    when: << pipeline.parameters.run-couchbase-workflow >>
    jobs:
      - data-couchbase/build-couchbase:
          context:
            - posey-prod-core
            - posey-prod-data
          filters:
            branches:
              only:
                - main
                - develop
            tags:
              only: /^v.*/

  # Vector DB workflow
  vector-db:
    when: << pipeline.parameters.run-vector-db-workflow >>
    jobs:
      - data-vector-db/build-vector-db:
          context:
            - posey-prod-core
            - posey-prod-data
          filters:
            branches:
              only:
                - main
                - develop
            tags:
              only: /^v.*/

  # Combined workflow for when common orb changes
  all-services:
    when: << pipeline.parameters.run-common-change-workflow >>
    jobs:
      - data-postgres/build-postgres:
          context:
            - posey-prod-core
            - posey-prod-data
      - data-couchbase/build-couchbase:
          context:
            - posey-prod-core
            - posey-prod-data
      - data-vector-db/build-vector-db:
          context:
            - posey-prod-core
            - posey-prod-data 
      - service-auth/build-auth-service:
          context:
            - posey-prod-core
            - posey-prod-services
      - service-cron/build-cron-service:
          context:
            - posey-prod-core
            - posey-prod-services
      - service-mcp/build-mcp-service:
          context:
            - posey-prod-core
            - posey-prod-services
      - service-supertokens/build-supertokens-service:
          context:
            - posey-prod-core
            - posey-prod-services
      - service-voyager/build-voyager-service:
          context:
            - posey-prod-core
            - posey-prod-services
      - service-agents/build-agents-service:
          context:
            - posey-prod-core
            - posey-prod-services